---
layout: default
---

<!-- Header SCAN -->
<header class="site-header">
  <div class="container header-row">
    <a class="brand-scan" href="{{ site.baseurl }}/">SCAN</a>

    <form class="search-form" onsubmit="event.preventDefault(); buscarCapitulo();">
      <input id="qcap" type="search" placeholder="Buscar capÃ­tulosâ€¦">
      <button>Buscar</button>
    </form>

    <a class="btn-back" href="{{ site.baseurl }}/">Volver al inicio</a>
  </div>
</header>

<main class="container">
  <!-- Portada + Ficha -->
  <div class="manga-hero ui-block">
    <div class="manga-cover">
      <img src="{{ page.portada | default: '/assets/img/placeholder-cover.png' }}"
           alt="Portada de {{ page.title }}">
      <a class="btn-back" href="{{ site.baseurl }}/">Volver al inicio</a>
    </div>

    {% include manga_ficha.html %}
  </div>

  <!-- ðŸ‘‡ CLAVE: contenido del post/pÃ¡gina -->
  <article class="reader-content">
    {{ content }}
  </article>
</main>

<!-- Datos seguros para JS (evita Liquid complejo dentro de <script>) -->
<div id="page-data"
     data-baseurl="{{ site.baseurl | escape }}"
     data-series="{{ page.series | default: '' | escape }}"
     data-page='{{ page | jsonify | replace: "</", "<\\/" }}'
     hidden></div>

<script>
  // ====== Vars desde HTML â†’ JS (robusto para GitHub Pages) ======
  const __el    = document.getElementById('page-data');
  const BASEURL = __el?.dataset.baseurl || '';
  const SERIES  = __el?.dataset.series  || '';
  const PAGE    = (()=>{ try { return JSON.parse(__el?.dataset.page || '{}'); } catch { return {}; } })();

  // ====== Buscador simple en la pÃ¡gina ======
  function buscarCapitulo(){
    const v = (document.getElementById('qcap')?.value || '').toLowerCase();
    if(!v) return;
    const els = [...document.querySelectorAll('a, li, h2, h3, p')];
    let first = null;
    els.forEach(el=>{
      const hit = el.textContent.toLowerCase().includes(v);
      if(hit && !first) first = el;
      el.style.outline = hit ? '2px solid rgba(180,120,255,.5)' : '';
    });
    if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // ====== Autocompletar ficha desde catalogo.json (opcional) ======
  (async function hydrateFromCatalog(){
    // Solo hidratar si faltan campos comunes y hay series
    const needs = !('sinopsis' in PAGE) || !('autor' in PAGE) || !('generos' in PAGE);
    if(!needs || !SERIES) return;

    const urls = [`${BASEURL}/assets/data/catalogo.json`, `${BASEURL}/catalogo.json`];
    let catalog = null;
    for (const u of urls) {
      try {
        const r = await fetch(u, {cache:'no-store'});
        if(r.ok){ catalog = await r.json(); break; }
      } catch(e){}
    }
    if(!catalog) return;

    // Soporta JSON plano o por secciones/latest
    let items = [];
    if (Array.isArray(catalog)) items = catalog;
    else if (catalog.sections && Array.isArray(catalog.sections)) {
      items = catalog.sections.flatMap(s => s.items || []);
    } else if (catalog.latest && Array.isArray(catalog.latest)) {
      items = catalog.latest;
    }

    const found = items.find(x => (x.slug || x.series) === SERIES);
    if(!found) return;

    const metaList = document.querySelector('.manga-meta-list');
    const metaBox  = document.querySelector('.manga-meta');
    const coverImg = document.querySelector('.manga-cover img');

    const addLine = (label, value)=>{
      if(!metaList || value==null) return;
      const li = document.createElement('li');
      li.innerHTML = `<strong>${label}:</strong> ${Array.isArray(value)?value.join(', '):value}`;
      metaList.appendChild(li);
    };

    if(!PAGE.portada && found.portada && coverImg) coverImg.src = found.portada;

    if(!PAGE.sinopsis && found.sinopsis){
      let p = document.querySelector('.manga-sinopsis');
      if(!p){
        const h = document.createElement('h3'); h.textContent = 'Sinopsis';
        p = document.createElement('p'); p.className = 'manga-sinopsis';
        if(metaBox){ metaBox.appendChild(h); metaBox.appendChild(p); }
      }
      if(p) p.textContent = found.sinopsis;
    }

    if(!PAGE.autor     && found.autor)     addLine('Autor',     found.autor);
    if(!PAGE.artista   && found.artista)   addLine('Arte',      found.artista);
    if(!PAGE.editorial && found.editorial) addLine('Editorial', found.editorial);
    if(!PAGE.generos   && found.generos)   addLine('GÃ©neros',   found.generos);
    if(!PAGE.estado    && found.estado)    addLine('Estado',    found.estado);
    if(!PAGE.anio      && found.anio)      addLine('AÃ±o',       found.anio);
  })();
</script>
