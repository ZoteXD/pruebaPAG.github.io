---
layout: default
---

<header class="site-header">
  <div class="bar">
    <div class="brand">Biblioteca</div>
    <div class="search"><input id="q" type="search" placeholder="Buscar manga…"></div>
    <a class="chip" href="#">Descarga la app</a>
  </div>
</header>

<main class="container">
  <!-- Activos -->
  <div class="section-title"><span class="bar"></span><h2>Nuestros proyectos activos</h2></div>
  <div class="grid" id="grid-activos" aria-live="polite"></div>

  <!-- Joints -->
  <div class="section-title" style="margin-top:36px"><span class="bar"></span><h2>Joints</h2></div>
  <div class="grid" id="grid-joints" aria-live="polite"></div>

  <!-- Finalizados -->
  <div class="section-title" style="margin-top:36px"><span class="bar"></span><h2>Proyectos finalizados</h2></div>
  <div class="grid" id="grid-finalizados" aria-live="polite"></div>
</main>

<script>
(function(){
  const CATALOG_URL = "{{ '/catalogo.json' | relative_url }}";

  const $ = sel => document.querySelector(sel);
  const grids = {
    activos: $('#grid-activos'),
    joints: $('#grid-joints'),
    finalizados: $('#grid-finalizados')
  };

  const state = { data: [], bySection: null, query: "" };

  const ensureArray = v => Array.isArray(v) ? v : [];

  // Card renderer
  function cardHTML(item){
    const title = (item.title || 'Sin título');
    const url   = item.url || '#';
    const cover = item.cover || 'https://via.placeholder.com/480x640?text=Cover';
    const genres = ensureArray(item.genres);
    const last  = item.last_label || '';
    const chips = genres.map(g => `<span class="chip">${g}</span>`).join('');
    return `
      <a class="card" href="${url}">
        <div class="card-cover">
          <img src="${cover}" alt="${title}" loading="lazy">
        </div>
        <div class="card-body">
          <h3 class="card-title">${title}</h3>
          <div class="chips">${chips}</div>
          <div class="meta">${last}</div>
        </div>
      </a>`;
  }

  function renderGrid(list, el){
    el.innerHTML = list.map(cardHTML).join('') || `<div class="meta">No hay elementos para mostrar.</div>`;
  }

  // Filtro por búsqueda
  function applySearch(items, q){
    if(!q) return items;
    const s = q.trim().toLowerCase();
    return items.filter(it => {
      const title = (it.title || '').toLowerCase();
      const genres = ensureArray(it.genres).join(' ').toLowerCase();
      return title.includes(s) || genres.includes(s);
    });
  }

  // Pinta según formato: objeto por secciones o lista plana con status
  function paint(){
    const q = state.query;

    if(state.bySection){
      const A = applySearch(state.bySection.activos || [], q);
      const J = applySearch(state.bySection.joints  || [], q);
      const F = applySearch(state.bySection.finalizados || [], q);
      renderGrid(A, grids.activos);
      renderGrid(J, grids.joints);
      renderGrid(F, grids.finalizados);
    }else{
      const activos      = applySearch(state.data.filter(x => (x.status||'').toLowerCase()==='activo'), q);
      const joints       = applySearch(state.data.filter(x => (x.status||'').toLowerCase()==='joint'), q);
      const finalizados  = applySearch(state.data.filter(x => (x.status||'').toLowerCase()==='finalizado'), q);
      renderGrid(activos, grids.activos);
      renderGrid(joints, grids.joints);
      renderGrid(finalizados, grids.finalizados);
    }
  }

  async function load(){
    // Loaders iniciales
    Object.values(grids).forEach(g => g.innerHTML = `<div class="meta">Cargando…</div>`);

    let raw;
    try{
      const res = await fetch(CATALOG_URL, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      raw = await res.json();
    }catch(err){
      console.error('Error cargando catalogo.json', err);
      Object.values(grids).forEach(g => g.innerHTML = `<div class="meta">No se pudo cargar el catálogo.</div>`);
      return;
    }

    // Detectar formato
    if(Array.isArray(raw)){
      state.data = raw;
      state.bySection = null;
    }else if(raw && typeof raw === 'object'){
      state.bySection = {
        activos: ensureArray(raw.activos),
        joints: ensureArray(raw.joints),
        finalizados: ensureArray(raw.finalizados)
      };
      state.data = []; // no se usa en este modo
    }else{
      Object.values(grids).forEach(g => g.innerHTML = `<div class="meta">Formato de catálogo no válido.</div>`);
      return;
    }

    paint();
  }

  // Buscar
  const qInput = document.getElementById('q');
  qInput?.addEventListener('input', (e)=>{ state.query = e.target.value; paint(); });

  load();
})();
</script>
