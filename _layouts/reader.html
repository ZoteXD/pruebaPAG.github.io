---
# Layout LECTOR: página completa (clona la base de default.html)
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ page.title | escape }}</title>

    {% if page.use_main_css %}
      <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/main.css">
    {% else %}
      <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/style.css">
    {% endif %}

    <style>
      /* Estilos específicos para el lector */
      .wrapper-masthead { display: none; }

      :root { --navH: 56px; }

      /* Hero del reader */
      .reader-hero{
        text-align:center;
        padding: 24px 12px 8px;
      }
      .reader-title{
        margin:0;
        font-weight: 800;
        line-height: 1.1;
        /* tamaño fluido */
        font-size: clamp(28px, 4.5vw, 48px);
      }
      .reader-sub{
        margin-top: 6px;
        opacity: .85;
        font-size: clamp(16px, 2.4vw, 22px);
      }

      /* El contador sigue flotante en la esquina */
      #pager{
        position: fixed;
        top: 12px; right: 16px;
        background: rgba(0,0,0,.6);
        color: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 9999;
      }


      /* Fullscreen */
      .reader { width: 100%; margin: 0; padding: 0; }
      .reader .page { margin: 0; }
      .reader .page img{
        display:block; width:100%; height:auto; max-width:100%;
      }

      /* Contador flotante */
      #pager{
        position:fixed; top:12px; right:16px;
        background:rgba(0,0,0,.6); color:#fff;
        padding:4px 8px; border-radius:6px; font-size:14px; z-index:9999;
      }

      /* Topbar simple (título) */
      .topbar{ display:flex; align-items:center; gap:12px; margin:12px 0 16px 0; }
      .topbar .title{ font-weight:700; }
      .topbar .spacer{ flex:1; }
      .pager{ opacity:.7; font-variant-numeric:tabular-nums; }

      /* NAV FIJA (arriba o abajo) */
      .nav-fixed{
        position:fixed; left:0; right:0; z-index:10000;
        display:flex; gap:12px; justify-content:center; align-items:center;
        height:var(--navH);
        padding:8px 12px;
        background:rgba(30,30,30,.75);
        backdrop-filter: blur(6px);
      }
      .nav-fixed.bottom{ bottom:0; }
      .nav-fixed.top{ top:0; }

      /* espacio para que no tape contenido */
      body.has-nav-bottom { padding-bottom: var(--navH); }
      body.has-nav-top    { padding-top: var(--navH); }

      .btn{
        display:inline-block; padding:8px 14px; border-radius:10px;
        text-decoration:none; border:1px solid #bbb; background:#fff; color:#111;
        font-weight:600;
      }
      .btn.dark{
        background:#222; color:#fff; border-color:#444;
      }

      .back{ display:none; } /* ocultamos el link suelto; ya va en la barra fija */
      .error{ color:#c33; font-weight:600; margin:8px 0; }
    </style>
  </head>

  <!-- Usa has-nav-bottom (barra abajo) o has-nav-top (barra arriba) -->
  <body class="has-nav-bottom{% if page.use_main_css %} theme{% endif %}">
    <!-- Encabezado: SIN el nav con Inicio/About -->
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="{{ site.baseurl }}/" class="site-avatar"><img src="{{ site.avatar }}" /></a>
          <div class="site-info">
            <h1 class="site-name"><a href="{{ site.baseurl }}/">{{ site.name }}</a></h1>
            <p class="site-description">{{ site.description }}</p>
          </div>
          <!-- nav eliminado -->
        </header>
      </div>
    </div>

    <!-- Contenido del lector -->
    <header class="reader-hero">
      <h1 class="reader-title">
        {{ page.manga | default: page.title | default: "Manga" }}
      </h1>
      <div class="reader-sub">
        Capítulo {{ page.capitulo | default: "?" }}
      </div>
      <div id="pager" class="pager">Pag 0 / 0</div>
    </header>


      <div id="reader" class="reader"></div>

      <!-- Link “regresar” del layout original (oculto). La barra fija lo reemplaza. -->
      <a class="back" href="{{ site.baseurl }}{{ page.return_to | default: '/' }}">← Regresar al post</a>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          {% include svg-icons.html %}
        </footer>
      </div>
    </div>

    <!-- BARRA DE NAVEGACIÓN FIJA -->
    <div class="nav-fixed bottom" id="navReader">
      {% if page.capitulo and page.capitulo > 1 %}
        <a class="btn dark" href="{{ site.baseurl }}/{{ page.manga_slug }}/cap{{ page.capitulo | minus:1 }}/">← Anterior</a>
      {% else %}
        <span></span>
      {% endif %}

      {% if page.es_ultimo != true %}
        <a class="btn dark" href="{{ site.baseurl }}/{{ page.manga_slug }}/cap{{ page.capitulo | plus:1 }}/">Siguiente →</a>
      {% endif %}

      <a class="btn" href="{{ site.baseurl }}{{ page.return_to | default: '/' }}">← Regresar al post</a>
    </div>

    {% include analytics.html %}

<script>
(async () => {
  const BASE = '{{ site.baseurl }}';
  const RAW  = ('{{ page.images_json }}' || '').trim();

  // Si prefieres la barra fija ARRIBA, cambia clases:
  // document.body.classList.remove('has-nav-bottom'); document.body.classList.add('has-nav-top');
  // document.getElementById('navReader').classList.remove('bottom'); document.getElementById('navReader').classList.add('top');

  // URL del JSON (absoluta o relativa)
  const JSON_URL = /^https?:\/\//i.test(RAW)
    ? RAW
    : (BASE + (RAW.startsWith('/') ? RAW : '/' + RAW));

  const mount   = document.getElementById('reader');
  const pagerEl = document.getElementById('pager');

  const withBase = (u) => /^https?:\/\//i.test(u) ? u : (BASE + (u.startsWith('/') ? u : '/' + u));

  function normalizeGoogleUrl(u){
    if (!u) return '';
    u = u.replace(
      /^https:\/\/drive\.google\.com\/uc\?export=(?:view|download)&id=([^&]+).*$/i,
      'https://drive.usercontent.google.com/uc?id=$1&export=download'
    );
    u = u.replace(/(drive\.usercontent\.google\.com\/uc\?[^#]*?)export=view/i, '$1export=download');
    return u;
  }

  function extractDriveId(u){
    if (!u) return '';
    let m = u.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
    if (m) return m[1];
    m = u.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/);
    if (m) return m[1];
    m = u.match(/\/open\?id=([a-zA-Z0-9_-]{10,})/);
    if (m) return m[1];
    return '';
  }

  function candidatesFrom(p){
    const tries = [];
    const u0 = normalizeGoogleUrl(String(p.url || ''));
    const id = p.id || extractDriveId(u0);

    if (id) {
      tries.push(
        `https://drive.google.com/thumbnail?id=${encodeURIComponent(id)}&sz=w2560`,
        `https://drive.usercontent.google.com/uc?id=${encodeURIComponent(id)}&export=download`,
        `https://drive.google.com/uc?export=view&id=${encodeURIComponent(id)}`
      );
    }
    if (u0) tries.push(u0);
    return [...new Set(tries)];
  }

  try {
    const res = await fetch(JSON_URL, { cache: 'no-cache' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    const pages = Array.isArray(data)
      ? data.map(u => ({ url: u }))
      : (Array.isArray(data.pages) ? data.pages : []);

    if (!pages.length) throw new Error('JSON vacío o formato no soportado');

    pages.sort((a, b) => {
      const A = parseInt((String(a.name || a.url || '').match(/(\d+)/) || [, '999999'])[1], 10);
      const B = parseInt((String(b.name || b.url || '').match(/(\d+)/) || [, '999999'])[1], 10);
      return A - B;
    });

    const items = pages.map((p, i) => {
      const fig = document.createElement('figure');
      fig.className = 'page';

      const img = document.createElement('img');
      img.alt = `Página ${i + 1}`;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.referrerPolicy = 'no-referrer';
      img.sizes = '100vw';

      fig.appendChild(img);
      return { fig, img, tries: candidatesFrom(p), index: i };
    });

    const frag = document.createDocumentFragment();
    items.forEach(it => frag.appendChild(it.fig));
    mount.textContent = '';
    mount.appendChild(frag);

    pagerEl.textContent = `Pag ${items.length ? 1 : 0} / ${items.length}`;

    // Counter flotante
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries) => {
        const vis = entries.filter(e => e.isIntersecting)
                           .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
        if (vis) {
          const idx = items.findIndex(x => x.fig === vis.target);
          if (idx >= 0) pagerEl.textContent = `Pag ${idx + 1} / ${items.length}`;
        }
      }, { root: null, rootMargin: '0px 0px -40% 0px', threshold: [0.2, 0.4, 0.6] });
      items.forEach(it => io.observe(it.fig));
    }

    // Descarga con concurrencia y upgrade a full
    const CONCURRENCY = 6, INTERVAL_MS = 0;
    let cursor = 0;

    function loadOne(it){
      return new Promise((resolve) => {
        const all = it.tries.slice();
        if (!all.length) return resolve();

        const first = withBase(all.shift()); // thumb primero
        let upgraded = false;

        it.img.onload = () => {
          const full = all.find(u =>
            u.includes('drive.usercontent.google.com/uc') && u.includes('id=')
          );
          if (full) {
            const thumb = it.tries.find(u => u.includes('thumbnail?'));
            const pre = new Image();
            pre.referrerPolicy = 'no-referrer';
            pre.onload  = () => {
              if (!upgraded) {
                upgraded = true;
                it.img.src = withBase(full);
                if (thumb) {
                  it.img.srcset = `${withBase(thumb)} 1x, ${withBase(full)} 2x`;
                  it.img.sizes  = '100vw';
                }
              }
              resolve();
            };
            pre.onerror = () => resolve();
            pre.src = withBase(full);
          } else {
            resolve();
          }
        };

        const next = () => {
          if (!all.length) {
            const warn = document.createElement('div');
            warn.className = 'error';
            warn.textContent = `⚠️ No se pudo cargar la página ${it.index + 1}`;
            it.fig.insertBefore(warn, it.fig.firstChild);
            return resolve();
          }
          const u = withBase(all.shift());
          it.img.onerror = next;
          it.img.onload  = resolve;
          it.img.src = u;
        };

        it.img.onerror = next;
        it.img.src = first;
      });
    }

    async function worker(){
      while (true) {
        const i = cursor++;
        if (i >= items.length) break;
        await loadOne(items[i]);
        if (INTERVAL_MS) await new Promise(r => setTimeout(r, INTERVAL_MS));
      }
    }

    await Promise.all(Array.from({length: CONCURRENCY}, worker));

  } catch (err) {
    mount.innerHTML = `<p class="error">No se pudieron cargar las imágenes. ${err.message}</p>`;
    pagerEl.textContent = 'Pag 0 / 0';
  }
})();
</script>
  </body>
</html>
