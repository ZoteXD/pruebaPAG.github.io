---
# Layout LECTOR: página completa (clona la base de default.html)
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ page.title | escape }}</title>

    {% if page.use_main_css %}
      <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/main.css">
    {% else %}
      <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/style.css">
    {% endif %}

    <!-- Ajustes extra para nitidez en pantallas grandes -->
    <style>
      /* Limita el ancho del lector para que no se estire de más en monitores anchos */
      .reader {
        max-width: 1200px;   /* ajusta 1100–1400 según tu resolución original */
        margin: 0 auto;
        padding: 0 12px;
      }

      /* Centra cada página y evita estirar más allá de su tamaño natural */
      .reader .page {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        margin: 0 auto 12px auto;
      }

      .reader .page img {
        display: block;
        height: auto;
        max-width: 100%; /* escala hacia abajo si el contenedor es menor */
        width: auto;     /* no escales por encima del tamaño natural */
        image-rendering: auto;
      }

      .reader .page figcaption {
        text-align: center;
        opacity: .6;
        font-size: .9rem;
        margin-top: 6px;
      }

      .reader .page .error {
        color: #c33;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .topbar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 12px 0 16px 0;
      }
      .topbar .title { font-weight: 700; }
      .topbar .spacer { flex: 1; }
      .pager { opacity: .7; font-variant-numeric: tabular-nums; }

      .nav-buttons {
        display: flex;
        justify-content: space-between;
        margin: 16px 0;
      }
      .nav-buttons .btn {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 8px;
        text-decoration: none;
        border: 1px solid #ccc;
      }

      .back { display: inline-block; margin-bottom: 24px; }
    </style>
  </head>

  <body{% if page.use_main_css %} class="theme"{% endif %}>
    <!-- Encabezado igual a default.html -->
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="{{ site.baseurl }}/" class="site-avatar"><img src="{{ site.avatar }}" /></a>
          <div class="site-info">
            <h1 class="site-name"><a href="{{ site.baseurl }}/">{{ site.name }}</a></h1>
            <p class="site-description">{{ site.description }}</p>
          </div>
          <nav>
            <a href="{{ site.baseurl }}/">Inicio</a>
            <a href="{{ site.baseurl }}/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <!-- Contenido del lector -->
    <div id="main" role="main" class="container">

      <!-- Barra con título y pager -->
      <header class="topbar">
        <div class="title">
          {{ page.manga | default: page.title | default: "Manga" }} - Capítulo {{ page.capitulo | default: "?" }}
        </div>
        <div class="spacer"></div>
        <div id="pager" class="pager">Pag 0 / 0</div>
      </header>

      <!-- Contenedor de imágenes -->
      <div id="reader" class="reader"></div>

      <!-- Botones de navegación -->
      <div class="nav-buttons">
        {% if page.capitulo and page.capitulo > 1 %}
          <a class="btn" href="{{ site.baseurl }}/{{ page.manga_slug }}/cap{{ page.capitulo | minus:1 }}/">← Anterior</a>
        {% else %}
          <span></span>
        {% endif %}

        {% if page.es_ultimo != true %}
          <a class="btn" href="{{ site.baseurl }}/{{ page.manga_slug }}/cap{{ page.capitulo | plus:1 }}/">Siguiente →</a>
        {% endif %}
      </div>

      <!-- Regresar al post -->
      <a class="back" href="{{ site.baseurl }}{{ page.return_to | default: '/' }}">← Regresar al post</a>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          {% include svg-icons.html %}
        </footer>
      </div>
    </div>

    {% include analytics.html %}

  <script>
  (async () => {
    const BASE = '{{ site.baseurl }}';
    const RAW  = ('{{ page.images_json }}' || '').trim();

    // Resuelve URL del JSON (absoluta o relativa al sitio)
    const JSON_URL = /^https?:\/\//i.test(RAW)
      ? RAW
      : (BASE + (RAW.startsWith('/') ? RAW : '/' + RAW));

    const mount   = document.getElementById('reader');
    const pagerEl = document.getElementById('pager');

    // ---------- Helpers ----------
    const withBase = (u) => /^https?:\/\//i.test(u) ? u : (BASE + (u.startsWith('/') ? u : '/' + u));

    // Normaliza drive a usercontent+download (mejor para <img>)
    function normalizeGoogleUrl(u){
      if (!u) return '';
      // drive.google.com -> usercontent (download)
      u = u.replace(
        /^https:\/\/drive\.google\.com\/uc\?export=(?:view|download)&id=([^&]+).*$/i,
        'https://drive.usercontent.google.com/uc?id=$1&export=download'
      );
      // si ya es usercontent pero viene con view -> download
      u = u.replace(
        /(drive\.usercontent\.google\.com\/uc\?[^#]*?)export=view/i,
        '$1export=download'
      );
      return u;
    }

    // Extrae fileId de varias formas de URL de Drive
    function extractDriveId(u){
      if (!u) return '';
      let m = u.match(/[?&]id=([a-zA-Z0-9_-]{10,})/); // ...uc?export=*&id=FILEID
      if (m) return m[1];
      m = u.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/); // .../file/d/FILEID/...
      if (m) return m[1];
      m = u.match(/\/open\?id=([a-zA-Z0-9_-]{10,})/); // .../open?id=FILEID
      if (m) return m[1];
      return '';
    }

    // Genera candidatos con orden: thumbnail (grande) -> full (usercontent) -> view -> (URL del JSON normalizada)
    function candidatesFrom(p){
      const tries = [];
      const u0 = normalizeGoogleUrl(String(p.url || ''));
      const id = p.id || extractDriveId(u0);

      if (id) {
        tries.push(
          `https://drive.google.com/thumbnail?id=${encodeURIComponent(id)}&sz=w2560`, // thumb más grande
          `https://drive.usercontent.google.com/uc?id=${encodeURIComponent(id)}&export=download`, // full
          `https://drive.google.com/uc?export=view&id=${encodeURIComponent(id)}` // fallback
        );
      }
      if (u0) tries.push(u0); // deja la URL original al final

      // Quita duplicados
      return [...new Set(tries)];
    }
    // --------------------------------

    try {
      const res = await fetch(JSON_URL, { cache: 'no-cache' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      // Acepta array simple o {pages:[...]}
      const pages = Array.isArray(data)
        ? data.map(u => ({ url: u }))
        : (Array.isArray(data.pages) ? data.pages : []);

      if (!pages.length) throw new Error('JSON vacío o formato no soportado');

      // Orden por primer número
      pages.sort((a, b) => {
        const A = parseInt((String(a.name || a.url || '').match(/(\d+)/) || [, '999999'])[1], 10);
        const B = parseInt((String(b.name || b.url || '').match(/(\d+)/) || [, '999999'])[1], 10);
        return A - B;
      });

      // Pre-render
      const items = pages.map((p, i) => {
        const fig = document.createElement('figure');
        fig.className = 'page';

        const img = document.createElement('img');
        img.alt = `Página ${i + 1}`;
        img.loading = 'lazy';
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        // sizes por defecto (se refuerza luego en upgrade a full)
        img.sizes = '(max-width: 1200px) 100vw, 1200px';

        const cap = document.createElement('figcaption');
        cap.textContent = String(i + 1);

        fig.appendChild(img);
        fig.appendChild(cap);

        return { fig, img, tries: candidatesFrom(p), index: i };
      });

      const frag = document.createDocumentFragment();
      items.forEach(it => frag.appendChild(it.fig));
      mount.textContent = '';
      mount.appendChild(frag);

      pagerEl.textContent = `Pag ${items.length ? 1 : 0} / ${items.length}`;

      // Pager dinámico
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          const vis = entries.filter(e => e.isIntersecting)
                             .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
          if (vis) {
            const idx = items.findIndex(x => x.fig === vis.target);
            if (idx >= 0) pagerEl.textContent = `Pag ${idx + 1} / ${items.length}`;
          }
        }, { root: null, rootMargin: '0px 0px -40% 0px', threshold: [0.2, 0.4, 0.6] });
        items.forEach(it => io.observe(it.fig));
      }

      // === Descarga con concurrencia y "thumb-first → upgrade a full" ===
      const CONCURRENCY = 6;  // sube/baja según rate-limit
      const INTERVAL_MS = 0;  // pausa entre tareas (0 para máximo rendimiento)
      let cursor = 0;

      function loadOne(it){
        return new Promise((resolve) => {
          const all = it.tries.slice(); // copia: [thumb, full, view, ...]
          if (!all.length) return resolve();

          const first = withBase(all.shift()); // thumbnail primero
          let upgraded = false;

          // Cuando cargue lo primero, intenta upgrade a 'full'
          it.img.onload = () => {
            // Busca 'full' de forma más tolerante
            const full = all.find(u =>
              u.includes('drive.usercontent.google.com/uc') && u.includes('id=')
            );

            // Pre-carga y cambia a full (además setea srcset 1x/2x)
            if (full) {
              const thumb = it.tries.find(u => u.includes('thumbnail?'));
              const pre = new Image();
              pre.referrerPolicy = 'no-referrer';
              pre.onload  = () => {
                if (!upgraded) {
                  upgraded = true;
                  it.img.src = withBase(full);
                  if (thumb) {
                    it.img.srcset = `${withBase(thumb)} 1x, ${withBase(full)} 2x`;
                    it.img.sizes  = '(max-width: 1200px) 100vw, 1200px';
                  }
                }
                resolve();
              };
              pre.onerror = () => resolve();
              pre.src = withBase(full);
            } else {
              resolve();
            }
          };

          // Si falla el primer intento, encadena el resto (view / original)
          const next = () => {
            if (!all.length) {
              const warn = document.createElement('div');
              warn.className = 'error';
              warn.textContent = `⚠️ No se pudo cargar la página ${it.index + 1}`;
              it.fig.insertBefore(warn, it.fig.firstChild);
              return resolve();
            }
            const u = withBase(all.shift());
            it.img.onerror = next;
            it.img.onload  = resolve;
            it.img.src = u;
          };

          it.img.onerror = next;
          it.img.src = first; // dispara thumbnail
        });
      }

      async function worker(){
        while (true) {
          const i = cursor++;
          if (i >= items.length) break;
          await loadOne(items[i]);
          if (INTERVAL_MS) await new Promise(r => setTimeout(r, INTERVAL_MS));
        }
      }

      await Promise.all(Array.from({length: CONCURRENCY}, worker));
      // ===============================================================

    } catch (err) {
      mount.innerHTML = `<p class="error">No se pudieron cargar las imágenes. ${err.message}</p>`;
      pagerEl.textContent = 'Pag 0 / 0';
    }
  })();
  </script>
  </body>
</html>
